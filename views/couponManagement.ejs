<%-include('adminHeader')%>
    <div class="flex-1 flex ">

        <!-- navigation div -->
        <div class="p-2 bg-white absolute z-20 h-screen transition-all ease-linear duration-300 md:relative w-60 flex-col hidden md:flex"
            id="sideNav">
            <nav>
                <a class="block text-gray-500 py-2.5 px-4 my-4 rounded transition duration-200 hover:bg-gradient-to-r hover:from-cyan-400 hover:to-[#076AE1] hover:text-white"
                    href="/admin">
                    <i class="fas fa-home mr-2"></i>Dashboard
                </a>

                <a class="block text-gray-500 py-2.5 px-4 my-4 rounded transition duration-200 hover:bg-gradient-to-r hover:from-cyan-400 hover:to-[#076AE1] hover:text-white"
                    href="/admin/userMangement">
                    <i class="fas fa-users mr-2"></i>User Management
                </a>
                <a class="block text-gray-500 py-2.5 px-4 my-4 rounded transition duration-200 hover:bg-gradient-to-r hover:from-cyan-400 hover:to-[#076AE1] hover:text-white"
                    href="/admin/categoryManagement">
                    <i class="fa-solid fa-boxes-stacked mr-2"></i>Category Management
                </a>
                <a class="block text-gray-500 py-2.5 px-4 my-4 rounded transition duration-200 hover:bg-gradient-to-r hover:from-cyan-400 hover:to-[#076AE1] hover:text-white"
                    href="/admin/productManagement">
                    <i class="fas fa-store mr-2"></i>Product Management
                </a>

                <a class="block text-gray-500 py-2.5 px-4 my-4 rounded transition duration-200 hover:bg-gradient-to-r hover:from-cyan-400 hover:to-[#076AE1] hover:text-white"
                    href="#">
                    <i class="fas fa-exchange-alt mr-2"></i>Order Management
                </a>
                <a class="block py-2.5 px-4 my-4 rounded transition duration-200 bg-gradient-to-r from-cyan-400 to-[#076AE1] text-white"
                    href="/admin/couponManagement">
                    <i class="fa-sharp fas fa-regular fa-tag"></i></i> Coupon Mangement
                </a>
                <a class="block text-gray-500 py-2.5 px-4 my-4 rounded transition duration-200 hover:bg-gradient-to-r hover:from-cyan-400 hover:to-[#076AE1] hover:text-white"
                    href="#">
                    <i class="fas fa-file-alt mr-2"></i>Report
                </a>
                <a class="block text-gray-500 py-2.5 px-4 my-2 rounded transition duration-200 hover:bg-gradient-to-r hover:from-cyan-600 hover:to-[#076AE1] hover:text-white mt-auto"
                    href="/admin/logout">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </a>
            </nav>



        </div>
        <!-- content div -->
        <div class="flex justify-center w-full overflow-auto">
            <div class="flex flex-col overflow-auto pt-10 ">
                <!-- search -->
                <div class="mx-auto max-w-md">
                    <form action="" class="relative mx-auto w-max">
                        <input type="search"
                            class="appearance-none cursor-pointer relative z-10 h-12 w-full rounded-full border bg-transparent pl-12 outline-none  focus:cursor-text focus:border-gray-700  "
                            placeholder="Search Coupon" />
                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="absolute inset-y-0 my-auto h-8 w-12 border-r border-transparent stroke-gray-500 px-3.5 peer-focus:gray-200 "
                            fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </form>


                </div>

                <div class="overflow-x-hidden  lg:mx-0.5">


                    <!-- initialization of aphine values -->
                    <div x-data="{ editModal : false ,showModal: false, addModel:false,Code:'',Type:'',id:'',Value:'',Start:'',End:'',desc:'',minimumPurchase:''}"
                        class="py-2 inline-block min-w-full sm:px-6 lg:px-8">
                        <div class=" h-auto overflow-auto">

                            <div class="w-80 md:w-[33rem] sm:w-[40rem] md:flex justify-center lg:w-[70rem] overflow-auto">

                                <!-- Coupon Table -->
                                <table class="min-w-96 text-center table-fixed text-xs " id="myTable">
                                    <thead class="bg-gray-200 border-b max-w-[100px]">
                                        <tr>
                                            <th scope="col"
                                                class="text-sm font-medium text-gray-900 px-6 py-4 text-left">
                                                Coupon Code
                                            </th>

                                            <th scope="col"
                                                class="text-sm font-medium text-gray-900 px-6 py-4 text-left">
                                                Discount Type
                                            </th>
                                            <th scope="col"
                                                class="text-sm font-medium text-gray-900 px-6 py-4 text-left">
                                                Discount Value
                                            </th>
                                            <th scope="col"
                                                class="text-sm  w-28 overflow-hidden font-medium text-gray-900 px-6 py-4 text-left">
                                                Start Date
                                            </th>
                                            <th scope="col"
                                                class="text-sm font-medium text-gray-900 px-6 py-4 text-left">
                                                End Date
                                            </th>
                                            
                                            <th scope="col"
                                                class="text-sm font-medium text-gray-900 px-6 py-4 text-left">
                                                Action
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody >
                                        <% coupons.forEach(coupon=> { %>
                                            <tr
                                                class="bg-white  border-b transition duration-300 ease-in-out hover:bg-gray-100">

                                                <td
                                                    class="text-sm text-gray-900 font-light px-6 py-4 whitespace-nowrap">
                                                    <%= coupon.couponCode %>
                                                </td>
                                                <td
                                                    class="text-sm text-gray-900 font-light  overflow-hidden px-6 py-4 whitespace-nowrap">
                                                    <%= coupon.discountType %>
                                                </td>
                                                <td
                                                    class="text-sm text-gray-900 font-light max-w-[10px] overflow-hidden px-6 py-4 whitespace-nowrap">
                                                    <%= coupon.discountValue %>
                                                </td>
                                                <td
                                                    class="text-sm text-gray-900  font-light max-w-[140px]  overflow-hidden px-6 py-4 whitespace-nowrap">
                                                    <%= coupon.startDate %>
                                                </td>
                                                <td
                                                    class="text-sm text-gray-900 font-light  max-w-[140px] overflow-hidden px-6 py-4 whitespace-nowrap">
                                                    <%= coupon.endDate %>
                                                </td>
                                                <td
                                                    class="text-sm text-gray-900 font-light  text-center px-6 py-4 whitespace-nowrap">
                                                    <% 
                                                    let date = new Date(coupon.startDate);
                                                    let year = date.getFullYear();
                                                    let month = date.getMonth() + 1; // getMonth() is zero-based
                                                    let day = date.getDate();
                                                    
                                                    // Add leading zeros to month and day if they are less than 10
                                                    if (month < 10) {
                                                        month = '0' + month;
                                                    }
                                                    if (day < 10) {
                                                        day = '0' + day;
                                                    }
                                                    
                                                    let formattedStartDate=`${year}-${month}-${day}`
                                                    let date2 = new Date(coupon.endDate);
                                                    let year2 = date2.getFullYear();
                                                    let month2 = date2.getMonth() + 1; // getMonth() is zero-based
                                                    let day2 = date2.getDate();
                                                    
                                                    // Add leading zeros to month and day if they are less than 10
                                                    if (month2 < 10) {
                                                        month2 = '0' + month2;
                                                    }
                                                    if (day2 < 10) {
                                                        day2 = '0' + day2;
                                                    }
                                                    
                                                    let formattedEndDate = `${year2}-${month2}-${day2}`; 
                                                    %>
                                                    <button class="edit">
                                                        <i @click="editModal = !editModal ,id='<%= coupon._id %>',minimumPurchase='<%= coupon.minimumPurchase %>',Code='<%= coupon.couponCode %>',Type='<%= coupon.discountType %>',Value='<%= coupon.discountValue %>',End='<%=formattedEndDate %>',desc='<%= coupon.description %>',Start='<%=formattedStartDate %>'"
                                                            class="fa fa-edit fa-lg" style="color: green"
                                                            aria-hidden="true"></i>

                                                    </button>

                                                    <button @click="showModal = !showModal,id='<%= coupon._id %>'">
                                                        <i class="fas fa-thin fa-trash-can fa-lg"
                                                            style="color: #ff0000;"></i>
                                                    </button>

                                                </td>
                                            </tr>
                                            <% }); %>
                                    </tbody>
                                </table>

                                <!-- coupon DELETE -->
                                <div x-show="showModal"
                                    class="fixed text-gray-500 flex items-center justify-center overflow-auto z-50 bg-black bg-opacity-40 left-0 right-0 top-0 bottom-0"
                                    x-transition:enter="transition ease duration-300"
                                    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
                                    x-transition:leave="transition ease duration-300"
                                    x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
                                    <!-- Modal -->
                                    <div x-show="showModal" class="bg-white rounded-xl shadow-2xl p-6  mx-10"
                                        @click.away="showModal = false">
                                 
                                        <!-- Title -->
                                        <span class="font-bold block text-2xl mb-3">
                                            DO YOU Really want to Delete this Coupon
                                        </span>
                                        <span class="font-bold block text-xl text-red-700 mb-3">
                                            This action cant be undone
                                        </span>
                                        <!-- Buttons -->
                                        <div class="text-right space-x-5 mt-5">
                                            <a x-bind:href="'/admin/deleteCoupon/'+id">
                                                <button
                                                    class="toggle-block-button px-4 py-2 text-sm bg-white rounded-xl border transition-colors duration-150 ease-linear border-gray-200 text-gray-500 focus:outline-none focus:ring-0 font-bold hover:bg-red-700 hover:text-white focus:bg-indigo-50 focus:text-indigo">YES</button>
                                            </a>
                                            <button @click="showModal = !showModal"
                                                class=" px-4 py-2 text-sm bg-white rounded-xl border transition-colors duration-150 ease-linear border-gray-200 text-gray-500 focus:outline-none focus:ring-0 font-bold hover:bg-green-500 hover:text-white focus:bg-indigo-50 focus:text-indigo">NO</button>

                                        </div>
                                    </div>
                                </div>

                                <!-- Coupon edit modal-->
                                <div x-show="editModal"
                                    class="absolute text-gray-500 flex items-center justify-center overflow-auto z-50 bg-black bg-opacity-40 left-0 right-0 top-0 "
                                    x-transition:enter="transition ease duration-300"
                                    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
                                    x-transition:leave="transition ease duration-300"
                                    x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
                                    <!-- Modal -->
                                    <div x-show="editModal"
                                        class="bg-white h-auto rounded-xl sm:w-3/6 shadow-2xl p-6 overflow-auto my-5 w-96"
                                        @click.away="editModal = false">
                                        <!-- Title -->
                                        <span class="font-bold block text-2xl mb-3">
                                            Edit Coupon
                                        </span>
                                        <!-- Body -->
                                        <div>
                                            <form class="mt-3" action="/admin/editCoupon" method="POST">
                                                <input type="hidden" :value="id" name="id">
                                                <div>
                                                    <label class="block md:text-xs float-left text-gray-700">Coupon Code</label>
                                                    <input type="text" name="couponCode" 
                                                        placeholder="Enter Coupon"
                                                        class="w-full px-4 py-3 rounded-lg placeholder:text-sm bg-gray-200 mt-1 border focus:border-blue-500 focus:bg-white focus:outline-none"
                                                        autofocus="" autocomplete="" required="" disabled :value="Code">
                                                </div>
                                                <div>
                                                    <label
                                                        class="block md:text-xs mt-4 float-left text-gray-700">Description</label>
                                                    <textarea name="description" id="description"
                                                        placeholder="Enter description"
                                                        class="w-full px-4 py-3 rounded-lg placeholder:text-sm bg-gray-200 mt-1 border focus:border-blue-500 focus:bg-white focus:outline-none" 
                                                        required="" :value="desc" ></textarea>
                                                </div>
                                                <div>
                                                    <label
                                                        class="block md:text-xs mt-4 float-left text-gray-700">Discount Type</label>
                                                        <select name="discountType" :value="Type"
                                                        autofocus="" autocomplete="" required=""  class="w-full px-4 py-3 rounded-lg placeholder:text-sm bg-gray-200 mt-1 border focus:border-blue-500 focus:bg-white focus:outline-none" >
                                                            <option value="Percentage" >Percentage</option>
                                                            <option value="Fixed Amount" >Fixed Amount</option>
                                                        </select>
                                                        
                                                </div>
                                                <div>
                                                    <label
                                                        class="block md:text-xs mt-4 float-left text-gray-700">Discount Value</label>
                                                        <input type="text" name="discountValue" 
                                                        placeholder="Enter Value of the discount"
                                                        class="w-full px-4 py-3 rounded-lg placeholder:text-sm bg-gray-200 mt-1 border focus:border-blue-500 focus:bg-white focus:outline-none"
                                                        autofocus="" autocomplete="" required="" :value="Value" >
                                                </div>
                                                <div>
                                                    <label
                                                        class="block md:text-xs mt-4 float-left text-gray-700">Minimum Purchase</label>
                                                        <input type="text" name="minimumPurchase" 
                                                        placeholder="Enter Minimum Purchase amount"
                                                        class="w-full px-4 py-3 rounded-lg placeholder:text-sm bg-gray-200 mt-1 border focus:border-blue-500 focus:bg-white focus:outline-none"
                                                        autofocus="" autocomplete="" required="" :value="minimumPurchase" >
                                                </div>
                                                <div>
                                                    <label
                                                        class="block md:text-xs mt-4 float-left text-gray-700">Start Date</label>
                                                        <input type="date" name="startDate" 
                                                        class="w-full px-4 py-3 rounded-lg placeholder:text-sm bg-gray-200 mt-1 border focus:border-blue-500 focus:bg-white focus:outline-none"
                                                        autofocus="" autocomplete="" required="" :value="Start" >
                                                </div>
                                                <div>
                                                    <label
                                                        class="End block md:text-xs mt-4 float-left text-gray-700"> End Date</label>
                                                        <input type="date" name="endDate" 
                                                        
                                                        class="w-full px-4 py-3 rounded-lg placeholder:text-sm bg-gray-200 mt-1 border focus:border-blue-500 focus:bg-white focus:outline-none"
                                                        autofocus="" autocomplete="" required=""  :value="End">
                                                </div>


                                                <button type="submit"
                                                    class="w-full block bg-indigo-500 hover:bg-indigo-400 focus:bg-indigo-400 text-white font-semibold rounded-lg px-4 py-3 mt-5">SAVE</button>
                                            </form>

                                        </div>
                                    </div>
                                </div>

                                <!--Add Coupon modal-->
                                <div x-show="addModel"
                                    class="absolute text-gray-500 flex items-center justify-center overflow-auto z-50 bg-black bg-opacity-40 left-0 right-0 top-0 "
                                    x-transition:enter="transition ease duration-300"
                                    x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
                                    x-transition:leave="transition ease duration-300"
                                    x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0">
                                    <!-- Modal -->
                                    <div x-show="addModel"
                                        class="bg-white rounded-xl sm:w-3/6 w-96 overflow-auto my-5 shadow-2xl p-6 "
                                        @click.away="addModel = false">
                                        <!-- Title -->
                                        <span class="font-bold block text-2xl mb-3">
                                            ADD Coupon
                                        </span>
                                        <!-- Body -->
                                        <div>
                                            <form class="mt-3" action="/admin/addCoupon" method="POST" >
                                                <div>
                                                    <label class="block md:text-xs float-left text-gray-700">Coupon Code</label>
                                                    <input type="text" name="couponCode" 
                                                        placeholder="Enter Coupon Name"
                                                        class="w-full px-4 py-3 rounded-lg placeholder:text-sm bg-gray-200 mt-1 border focus:border-blue-500 focus:bg-white focus:outline-none"
                                                        autofocus="" autocomplete="" required="" >
                                                </div>
                                                <div>
                                                    <label
                                                        class="block md:text-xs mt-4 float-left text-gray-700">Description</label>
                                                    <textarea name="description" id="description"
                                                        placeholder="Enter description"
                                                        class="w-full px-4 py-3 rounded-lg placeholder:text-sm bg-gray-200 mt-1 border focus:border-blue-500 focus:bg-white focus:outline-none"
                                                        autofocus="" autocomplete="" required=""
                                                       ></textarea>
                                                </div>
                                                <div>
                                                    <label
                                                        class="block md:text-xs mt-4 float-left text-gray-700">Discount Type</label>
                                                        <select name="discountType" 
                                                        autofocus="" autocomplete="" required=""  class="w-full px-4 py-3 rounded-lg placeholder:text-sm bg-gray-200 mt-1 border focus:border-blue-500 focus:bg-white focus:outline-none" >
                                                            <option value="Percentage">Percentage</option>
                                                            <option value="Fixed Amount">Fixed Amount</option>
                                                        </select>
                                                        
                                                </div>
                                                <div>
                                                    <label
                                                        class="block md:text-xs mt-4 float-left text-gray-700">Discount Value</label>
                                                        <input type="text" name="discountValue" 
                                                        placeholder="Enter Discount Value"
                                                        class="w-full px-4 py-3 rounded-lg placeholder:text-sm bg-gray-200 mt-1 border focus:border-blue-500 focus:bg-white focus:outline-none"
                                                        autofocus="" autocomplete="" required="" >
                                                </div>
                                                <div>
                                                    <label
                                                        class="block md:text-xs mt-4 float-left text-gray-700">Minimum Purchase</label>
                                                        <input type="text" name="minimumPurchase" 
                                                        placeholder="Enter Minimum Purchase amount"
                                                        class="w-full px-4 py-3 rounded-lg placeholder:text-sm bg-gray-200 mt-1 border focus:border-blue-500 focus:bg-white focus:outline-none"
                                                        autofocus="" autocomplete="" required="" >
                                                </div>
                                                <div>
                                                    <label
                                                        class="block md:text-xs mt-4 float-left text-gray-700">Start Date</label>
                                                        <input type="date" name="startDate" 
                                                         
                                                        class="w-full px-4 py-3 rounded-lg placeholder:text-sm bg-gray-200 mt-1 border focus:border-blue-500 focus:bg-white focus:outline-none"
                                                        autofocus="" autocomplete="" required=""  >
                                                </div>
                                                <div>
                                                    <label
                                                        class="block md:text-xs mt-4 float-left text-gray-700"> End Date</label>
                                                        <input type="date" name="endDate" 
                                                        placeholder="Enter Coupon Name"
                                                        class="w-full px-4 py-3 rounded-lg placeholder:text-sm bg-gray-200 mt-1 border focus:border-blue-500 focus:bg-white focus:outline-none"
                                                        autofocus="" autocomplete="" required=""  >
                                                </div>

                                                <button type="submit"
                                                    class="w-full block bg-indigo-500 hover:bg-indigo-400 focus:bg-indigo-400 text-white font-semibold rounded-lg px-4 py-3 mt-5">SAVE</button>
                                            </form>


                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>
                        <div class=" mt-10 flex w-full justify-center">
                            <button @click="addModel = !addModel"
                                class="middle none w-52 center mr-4 rounded-lg bg-[#076AE1] py-3 px-6 font-sans text-xs font-bold uppercase text-white shadow-md shadow-blue-500/20 transition-all hover:shadow-lg hover:shadow-blue-500/40 focus:opacity-[0.85] focus:shadow-none active:opacity-[0.85] active:shadow-none disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none"
                                data-ripple-light="true">
                                Add new Coupon
                            </button>
                        </div>

                    </div>


                </div>
            </div>

        </div>

    </div>


    <!-- toast -->
    <div id="toast" class="fixed bottom-0 right-0 m-5 p-5 bg-black text-white rounded-lg shadow-lg hidden">
        <div id="progressBar"
            class="h-1.5 w-full bg-blue-gray-50 rounded-sm -translate-y-3 overflow-hidden  transition-all duration-15000 ease-linear">
            <div class="h-full bg-green-600" style="width: 0%;"></div>
        </div>
        <p id="toastMessage" class="mt-2">Error message</p>
    </div>

    </div>


    <!-- function for toast -->
    <script>


        function showToast(errorMessage) {
            
            // Get the toast, toastMessage, and progressBar elements
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const progressBar = document.getElementById('progressBar').firstElementChild;

            // Update the message and show the toast
            toastMessage.textContent = errorMessage;
            toast.classList.remove('hidden');

            // Update the width of the progress bar every 0.15 seconds for 5 seconds
            let width = 0;
            const intervalId = setInterval(() => {
                width += 1;
                progressBar.style.width = `${width}%`;

                // After 15 seconds, hide the toast and clear the interval
                if (width >= 100) {
                    toast.classList.add('hidden');
                    clearInterval(intervalId);
                    // Reset the width of the progress bar for the next toast message
                    progressBar.style.width = '0%';
                }
            }, 50); // 50 milliseconds * 100 iterations = 5 seconds
        }


    </script>

    <% if (errorMessage) { %>
        <script>
            let err = '<%= errorMessage %>';
            showToast(err);              
        </script>
        <% } %>

            <!--ReLOADING  -->
            <script>
                let scrollPosition = [
                    self.pageXOffset || document.documentElement.scrollLeft || document.body.scrollLeft,
                    self.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
                ];

                window.onload = function () {
                    window.scrollTo(scrollPosition[0], scrollPosition[1]);
                };
            </script>

        

            <!-- search -->
            <script>
                const searchInput = document.querySelector('input[type="search"]');
                const table = document.getElementById('myTable');
                searchInput.addEventListener('input', filterTable);
                function filterTable() {
                    const filter = this.value.toUpperCase();
                    const rows = table.getElementsByTagName('tr');

                    for (let i = 1; i < rows.length; i++) { // Start from 1 to skip the header row
                        let row = rows[i];


                        let cells = row.getElementsByTagName('td');

                        if (cells[0].textContent.toUpperCase().indexOf(filter) > -1) {
                            row.style.display = "";
                        } else {
                            row.style.display = "none";
                        }
                    }
                }


            </script>

            <!-- responsive nav bar -->
            <script>
                const menuBtn = document.getElementById('menuBtn');
                const sideNav = document.getElementById('sideNav');
                menuBtn.addEventListener('click', () => {
                    sideNav.classList.toggle('hidden');
                });
            </script>
            <script src="https://kit.fontawesome.com/2129bb9b13.js" crossorigin="anonymous"></script>

            <!--disable resubmisson of form -->
            <script>
                if (window.history.replaceState) {
                    window.history.replaceState(null, null, window.location.href);
                }
            </script>
            </body>

            </html>